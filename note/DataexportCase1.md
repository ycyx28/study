# 关于数据导出的case

## 一.case1场景
 将若干个商家的所有交易数据全部导出到excel，历史数据已经迁移到历史库，下单时间按月分区，每个商家数据在100w条以上。
### 版本1
 按商家分月查寻数据，使用poi解析导出到excel。
 #### 执行效果
执行效率非常慢，执行时间需要12H+，严重影响效率，查询日志发现查询sql速度很快，没有slow sql，但是excel生成却非常慢。
#### 问题分析
1. 每个商家数据量大于100w，内存消耗大，也是处理速度慢的一个原因。
2. 一次性保存落地到excel文件，磁盘io达到瓶颈，性能消耗高，导致处理极慢。
3. 导出到excel，需要进行数据解析和格式转换，速度慢的最重要的原因。

### 版本2
通过版本1问题分析，迅速修改方案
1. 不使用POI组件，使用原生IO的输入输出留，导出excel格式为.CSV，以逗号分隔，用CSV格式的Excel导出数据节省了额外的数据解析时间；
2. 商家数据按月查询且按月落地保存，每月数据都在上月生产的CSV文件进行追加，这样就解决了100w+的数据放在内存同时落地产生的内存消耗和磁盘IO瓶颈，大大提升了效率。
#### 执行效果
查询sql和导出速度非常快，由原来的12H+的时间提升到现在不到30分钟，但是由于使用逗号分隔来生产CSV文件，在生产CSV文件的时候有些小问题。
#### 优化方案
逗号用双引号包裹，如果字段中既有逗号，又有双引号，或者字段中有双引号开头，如果数据"aaa"、"aaa,ss"、aaa,ss需要在数据头尾加上双信号，且逗号用双引号包裹，数据中原有双引号需要替换成2个双引号，修改后数据为""aaa""、""aaa","ss""、"aaa","ss"。

问题解决
